### 一、实验目的

- 通过亲身实践深入理解并掌握在Windows系统上配置虚拟机
- 通过理解并掌握在Linux下编译大型工程的能力，掌握makefile等编译工具的利用
- 掌握并理解Linux的Kernel更新机制，了解Linux的系统原理

### 二、实验环境

#### 宿主机环境：

- 操作系统：Microsoft Windows 10 Professional 64bit 2004
- 虚拟化平台：VMWare Workstation 15.5
- CPU：AMD Ryzen 4800HS（已启动`AMD-V`硬件虚拟化支持）
- GPU：RTX 2060 Max-Q
- RAM：16GB DDR4

#### 虚拟机环境：

- 操作系统：Ubuntu 20.04 LTS Destop
- 当前Kernel版本：Linux ubuntu 5.4.0-40-generic #44-Ubuntu SMP Tue Jun 23 00:01:04 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux
- ![image-20200706102127881](C:\Users\syc\Desktop\信息安全综合训练Ⅰ\第一天\01.png)

### 三、实验过程

#### 1、虚拟机配置

##### （1）获取Ubuntu安装镜像

我选择的是从清华大学开源软件镜像站获取安装镜像：https://mirrors.tuna.tsinghua.edu.cn/ubuntu-cdimage/ubuntu/releases/

##### （2）配置VMware虚拟机

- 使用VMWare虚拟机安装向导
  - 先选择安装光盘映像文件
    - ![image-20200706095111712](C:\Users\syc\Desktop\信息安全综合训练Ⅰ\第一天\02.png)
  - 配置用户信息
    - ![image-20200706095209568](C:\Users\syc\Desktop\信息安全综合训练Ⅰ\第一天\03.png)
  - 命名虚拟机和安装位置
    - ![image-20200706095314610](C:\Users\syc\Desktop\信息安全综合训练Ⅰ\第一天\04png)
  - 指定磁盘容量
    - ![image-20200706095424541](C:\Users\syc\Desktop\信息安全综合训练Ⅰ\第一天\05.png)
  - 创建虚拟机，这里建议打开虚拟化引擎AMD-V/RVI和虚拟化CPU性能计数器
    - ![image-20200706095721679](C:\Users\syc\Desktop\信息安全综合训练Ⅰ\第一天\06.png)
  - 开始自动化安装过程
    - ![image-20200706100123689](C:\Users\syc\Desktop\信息安全综合训练Ⅰ\第一天\07.png)
  - 安装完毕
    - ![image-20200706101848586](C:\Users\syc\Desktop\信息安全综合训练Ⅰ\第一天\08.png)

#### 2、Ubuntu国内镜像加速调优

首先修改Linux和Python镜像至国内镜像加速体验

##### Linux/Ubuntu国内镜像

- 首先打开Software&Updates
- 选择Download from
- 选择Other...
- 在国家列表中找到China
- 推荐选择的镜像源为：
  - 清华大学镜像站：`mirrors.tuna.tsinghua.edu.cn`
  - 阿里云镜像站：`mirrors.aliyun.com`
- Choose Server
- 选择Close后等待刷新镜像仓库
- 在shell中执行
  - `sudo apt update`
    - ![image-20200706102356190](C:\Users\syc\Desktop\信息安全综合训练Ⅰ\第一天\09.png)
  - `sudo apt upgrade`
    - ![image-20200706102717738](C:\Users\syc\Desktop\信息安全综合训练Ⅰ\第一天\10.png)

##### Python国内镜像加速

首先切回用户主目录

```shell
cd ~
```

然后创建`.pip`目录

```shell
mkdir ~/.pip
cd ~/.pip
```

这里推荐编辑器使用传说中的神器`vim`

```shell
sudo apt install vim
```

在.pip目录下创建一个`pip.conf`文件

```shell
vim pip.conf
```

填入以下内容保存即可

```shell
[global]
index-url = https://pypi.tuna.tsinghua.edu.cn/simple
trusted-host = pypi.tuna.tsinghua.edu.cn
disable-pip-version-check = true
```

#### 3、 添加共享文件夹

![image-20200706103536450](C:\Users\syc\Desktop\信息安全综合训练Ⅰ\第一天\11.png)

共享文件夹挂载在系统 ，使用`ln -s`在桌面建立共享文件夹软链接

![image-20200706103702704](C:\Users\syc\Desktop\信息安全综合训练Ⅰ\第一天\12.png)

#### 4、 建立虚拟机快照

在进行编译内核这里操作之前，建议对虚拟机进行快照备份，防止数据丢失

![image-20200706104138767](C:\Users\syc\Desktop\信息安全综合训练Ⅰ\第一天\13.png)

#### 5、 编译Kernel

- 首先建立工作目录，使用以下命令

  - ```shell
    zxy@ubuntu:~/Desktop$ mkdir kernel_make
    zxy@ubuntu:~/Desktop$ cd kernel_make
    ```

- 我们要做的第一件事是下载内核源码。在 [Kernel.org](https://www.kernel.org/) 找到你要下载的所需内核的 URL。找到 URL 之后，使用如下命令（我以 5.7.7 内核为例） 来下载源码文件:

  - ```shell
    zxy@ubuntu:~/Desktop/kernel_make$ wget https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.7.7.tar.xz
    ```

- 解压压缩包

  - `sudo tar -xavf linux-5.7.7.tar.xz`

- 安装所需要的环境

  - 为了编译内核，我们首先得安装一些需要的环境。这可以通过一个命令来完成：
  - `sudo apt-get install gcc make libncurses5-dev openssl libssl-dev build-essential  pkg-config libc6-dev bison flex libelf-dev git fakeroot ncurses-dev xz-utils bc`

- 配置内核

  - 在正式编译内核之前，我们首先必须配置需要包含哪些模块。实际上，有一些非常简单的方式来配置。使用一个命令，你能拷贝当前内核的配置文件，然后使用可靠的 `menuconfig` 命令来做任何必要的更改。使用如下命令来完成：
  - `sudo cp /boot/config-$(uname -r) .config`
  - 现在有一个配置文件了，输入命令 `sudo make menuconfig`。该命令将打开一个配置工具，它可以遍历每个可用模块，然后启用或者禁用需要或者不需要的模块
  - ![image-20200706111058123](C:\Users\syc\Desktop\信息安全综合训练Ⅰ\第一天\14.png)
  - 配置并保存编译选项，然后退出

- 开始编译内核

  - 这里使用`make`指令，且指定`j`参数充分利用多核性能，例如

    ```shell
    make -j `getconf _NPROCESSORS_ONLN` deb-pkg LOCALVERSION=-s18281059
    ```

  - 用如下的命令安装那些之前启用的模块：`sudo make modules_install`

- 安装内核

  - `sudo make install`

- 启用内核作为引导

  - `sudo update-initramfs -c -k 5.7.7-s18281059`

- 更新 grub

  - `sudo update-grub`

- 重启计算机

  - `sudo reboot`

- 更新内核成功

  - ![image-20200706161359107](C:\Users\syc\Desktop\信息安全综合训练Ⅰ\第一天\15.png)

### 四、问题与解决方案

#### 1. Ubuntu 20.04 LTS与VMWare 15.5共享文件夹不显示

- 问题的原因是：Ubuntu 20.04 LTS与VMware 15.5的VMTools存在兼容性问题

- 解决方案：
  - 重新配置VMTools
  - `sudo vmware-config-tools.pl`

#### 2. 首次分配磁盘空间容量不足

- 问题的原因：磁盘空间容量不足
- 解决方案：
  - 虚拟机扩容磁盘容量
  - 将扩容的磁盘空间重新格式化分区挂载入根目录主分区